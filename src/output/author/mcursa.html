<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chamber of Inspection - mcursa</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="http://launchyard.com/images/favicon.png"/>
    <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
    
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
        
        <!--[if lte IE 7]>
            <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
            <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->
            
            <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->
                <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>
                
                
            </head>
            
            <body id="index" class="home">
<a class="github-fork-ribbon left-top" href="https://github.com/mcursa-jwt" data-ribbon="Fork me on GitHub" title="Fork me on GitHub luh">Fork me on GitHub</a>
                
                <div class="LaunchyardDetail">
                    <p>
                        <a href="/"></a><img src="http://www.launchyard.com/images/LY-identity.png" width="100" height="100" alt="my avatar"><br/>
                        mcursa jwt<br/>
                    </p>
                    <p>
                        a human web developer<br/>
                        <!-- bio here in the future -->
                    </p>
                </div>
                
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/solving-connection-pooling-and-2006.html">Solving connection pooling and 2006</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/mcursa.html">mcursa</a>
        </li>
        <li class="published" title="2023-08-29T22:12:00+08:00">
          on&nbsp;Tue 29 August 2023
        </li>

	</ul>
<p>Categories: <a href="/tag/dev.html">dev</a> <a href="/tag/mysql.html">mysql</a> <a href="/tag/db.html">db</a> </p>
</div><!-- /.post-info --><h1 id="overriding-dj_db_conn_pools-ensure_connection-method-with-pre-ping-and-timer">overriding <code>dj_db_conn_pool</code>&rsquo;s <code>ensure_connection()</code> method with pre-ping and timer<a class="headerlink" href="#overriding-dj_db_conn_pools-ensure_connection-method-with-pre-ping-and-timer" title="Permanent link">&para;</a></h1>
<p>We use <a href="https://pypi.org/project/django-db-connection-pool/">dj_db_conn_pool</a> as a simple way to pool connections in case of a surge in transactions initiated by client loads.</p>
<p>We were having trouble tweaking the library&rsquo;s parameters in <a href="#understanding-the-issue">the next section</a> to stop the <a href="https://dev.mysql.com/doc/refman/8.0/en/gone-away.html">mysql 2006 error</a> (<a href="https://stackoverflow.com/questions/26958592/django-after-upgrade-mysql-server-has-gone-away">stackoverflow</a>) from occurring on our process scheduling module&rsquo;s queries.</p>
<h3 id="the-fix-adding-a-ping-that-has-exception-handling-upon-failure">the fix: <a href="https://aber.sh/articles/Django-automatic-reconnect/">adding a ping (that has exception handling upon failure).</a><a class="headerlink" href="#the-fix-adding-a-ping-that-has-exception-handling-upon-failure" title="Permanent link">&para;</a></h3>
<p>This solves the problem for now - and still maintains pooling functionality.</p>
<!-- add logs to show still works -->

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">dj_db_conn_pool.backends.mysql</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">django.db.backends.utils</span> <span class="kn">import</span> <span class="n">CursorWrapper</span>
<span class="k">class</span> <span class="nc">DatabaseWrapper</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DatabaseWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    inherits dj_db_conn_pool.backends.mysql.base.DatabaseWrapper</span>

<span class="sd">    overrides ensure_connection to add pre-ping regardless</span>
<span class="sd">    of connection freshness (`sqlalchemy.pool.base._ConnectionFairy._checkout` function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">ensure_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wrapper references:</span>
<span class="sd">        ---</span>
<span class="sd">            - `type(self.connection)==sqlalchemy.pool.base._ConnectionFairy`</span>
<span class="sd">            - `type(self.connection.connection)==_mysql.connection`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ensuring existing connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="si">}</span><span class="s2"> with pre-ping.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">CursorWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_cursor</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to ensure existing connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="si">}</span><span class="s2">, creating new.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_database_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</code></pre></div>

<p>I still don&rsquo;t really like that it sends an extra pre-ping for each.</p>
<p>I couldnt find a similar issue online, with <code>dj_db_conn_pool</code> and <code>apscheduler</code>. 
Didn&rsquo;t the <code>sqlalchemy</code>/<code>django</code>/<code>dj_db_conn_pool</code> libraries implement a pre-ping? Turns out they did.</p>
<h1 id="understanding-the-issue-wip">understanding the issue (WIP)<a class="headerlink" href="#understanding-the-issue-wip" title="Permanent link">&para;</a></h1>
<p>we use <a href="https://apscheduler.readthedocs.io/en/3.x/"><code>apscheduler</code></a> library to schedule our jobs. so far, the issue occurs mostly on scheduled job&rsquo;s db transactions.</p>
<p>initially, the 2006 errors almost only occurred on the queries I was using to flag the execution status of jobs. After I removed that, it occured on jobs (&ndash; my lead did mention that they might open a connection per thread)</p>
<p><strong>hypo:</strong>
the same connection might have been referenced for later use, but connection has either been disconnected from the mysql server or by the parameters set.</p>
<p>the important parameters (and their references):</p>
<p><code>Pool</code> (sqlalchemy/pool/base.py)</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Identified</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">EventTarget</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="o">...</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="c1"># self,</span>
        <span class="c1"># creator: Union[_CreatorFnType, _CreatorWRecFnType],</span>
        <span class="n">recycle</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1"># echo: log._EchoFlagType = None,</span>
        <span class="c1"># logging_name: Optional[str] = None,</span>
        <span class="c1"># reset_on_return: _ResetStyleArgType = True,</span>
        <span class="c1"># events: Optional[List[Tuple[_ListenerFnType, str]]] = None,</span>
        <span class="c1"># dialect: Optional[Union[_ConnDialect, Dialect]] = None,</span>
        <span class="n">pre_ping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="c1"># _dispatch: Optional[_DispatchCommon[Pool]] = None,</span>
    <span class="p">)</span>
        <span class="o">...</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param recycle: If set to a value other than -1, number of</span>
<span class="sd">              seconds between connection recycling, which means upon</span>
<span class="sd">              checkout, if this timeout is surpassed the connection will be</span>
<span class="sd">              closed and replaced with a newly opened connection. Defaults to -1.</span>
<span class="sd">        :param pre_ping: if True, the pool will emit a &quot;ping&quot; (typically</span>
<span class="sd">             &quot;SELECT 1&quot;, but is dialect-specific) on the connection</span>
<span class="sd">             upon checkout, to test if the connection is alive or not.   If not,</span>
<span class="sd">             the connection is transparently re-connected and upon success, all</span>
<span class="sd">             other pooled connections established prior to that timestamp are</span>
<span class="sd">             invalidated.     Requires that a dialect is passed as well to</span>
<span class="sd">             interpret the disconnection error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</code></pre></div>

<p><code>QueuePool</code> (sqlalchemy/pool/impl.py)</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QueuePool</span><span class="p">(</span><span class="n">Pool</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">creator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_CreatorFnType</span><span class="p">,</span> <span class="n">_CreatorWRecFnType</span><span class="p">],</span>
        <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_overflow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">use_lifo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param timeout: The number of seconds to wait before giving up</span>
<span class="sd">          on returning a connection. Defaults to 30.0. This can be a float</span>
<span class="sd">          but is subject to the limitations of Python time functions which</span>
<span class="sd">          may not be reliable in the tens of milliseconds.</span>
<span class="sd">          &quot;&quot;&quot;</span>
</code></pre></div>

<p>implementation: dj_db_conn_pool.core.mixins.PooledDatabaseWrapperMixin.get_new_connection()</p>
<p>Error was being thrown on connection fairy&rsquo;s _checkout method</p>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/releasing-with-git-flow.html">Releasing with git flow</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/mcursa.html">mcursa</a>
        </li>
        <li class="published" title="2023-08-18T16:27:00+08:00">
          on&nbsp;Fri 18 August 2023
        </li>

	</ul>
<p>Categories: <a href="/tag/dev.html">dev</a> <a href="/tag/devops.html">devops</a> <a href="/tag/git.html">git</a> </p>
</div><!-- /.post-info --><h2 id="git-flow-release-notes-template-and-building-to-gitlab">Git flow + release notes template  (and building to gitlab)<a class="headerlink" href="#git-flow-release-notes-template-and-building-to-gitlab" title="Permanent link">&para;</a></h2>
<h2 id="our-release-gitflow">our release gitflow:<a class="headerlink" href="#our-release-gitflow" title="Permanent link">&para;</a></h2>
<p><img alt="release gitflow" src="../images/release_git_flow.png" />
<br>
Learning to use the traditional <a href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow">git flow</a></p>
<p>with each release, my team runs a period of staging, the length depending on urgency. During staging, bugfixes and tweaks (for this release) will be done on <code>release-fixes</code>. this will branch from <code>release</code></p>
<p>After we are satisfied with the release candidate (rc), we will merge onto main for production release. In production, any urgent fixes will be done on the &lsquo;hotfix&rsquo; branch. This will be the only branch to branch directly off <code>main</code>.</p>
<h2 id="generating-release-notes">generating release notes<a class="headerlink" href="#generating-release-notes" title="Permanent link">&para;</a></h2>
<p>this command will generate release notes using:
- commits from previous version tag to release version tag
- release notes template</p>
<div class="highlight"><pre><span></span><code><span class="nv">VERSION</span><span class="o">=</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">;</span><span class="nv">PREVIOUS_VERSION</span><span class="o">=</span><span class="s1">&#39;1.0.0.rc&#39;</span><span class="p">;</span><span class="w"> </span><span class="nv">CHANGES</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>log<span class="w"> </span>--no-merges<span class="w"> </span>origin/release<span class="w"> </span>--pretty<span class="o">=</span>oneline<span class="w"> </span>--format<span class="o">=</span><span class="s2">&quot;1. %s [%H]%d&quot;</span><span class="w"> </span><span class="nv">$VERSION</span>...<span class="nv">$PREVIOUS_VERSION</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;# Image\n\`\`\`\ndocker image pull registry.gitlab.com/your/app_name:</span><span class="nv">$VERSION</span><span class="s2"> # main server\ndocker image pull registry.gitlab.com/your/app_name:</span><span class="nv">$VERSION</span><span class="s2">.ocpp # ocpp server\n\`\`\` \n\n### Release Scope:\n\n### New features:\n\n### Notes:\n\n## Changes\n</span><span class="nv">$CHANGES</span><span class="s2">\n\n## Metadata\n\`\`\`\nThis version -------- </span><span class="nv">$VERSION</span><span class="s2">\nPrevious version ---- </span><span class="nv">$PREVIOUS_VERSION</span><span class="s2">\nTotal commits ------- </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CHANGES</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span><span class="s2">\n\`\`\`\n&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/tmp/release_notes_<span class="nv">$VERSION</span>.md<span class="p">;</span><span class="w"> </span>
vim<span class="w"> </span>/tmp/release_notes_<span class="nv">$VERSION</span>.md<span class="w"> </span><span class="c1"># can be any other text editor</span>
</code></pre></div>

<p>edit the output file to include content for:
- image tags
- release scope
  - reason for release
  - feature rollout
  - bugfixes</p>
<p>We use release scopes that are sub-scopes of our current sprint</p>
<h2 id="building-for-release">building for release<a class="headerlink" href="#building-for-release" title="Permanent link">&para;</a></h2>
<p>first make sure you are in the right version (and folder repository)</p>
<div class="highlight"><pre><span></span><code>app_name/$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-f<span class="w"> </span><span class="m">1</span>.0.0
</code></pre></div>

<p>then build</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>registry.gitlab.com/your/app_name:1.0.0<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>registry.gitlab.com/your/app_name:1.0.0
sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>ocpp.Dockerfile<span class="w"> </span>-t<span class="w"> </span>registry.gitlab.com/your/app_name:1.0.0.ocpp<span class="w"> </span>.<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>registry.gitlab.com/your/app_name:1.0.0.ocpp
</code></pre></div>
                    </article>
                </div>
            </aside><!-- /#featured -->
            
        
        

    
            <aside id="featured">
                <div class="body">
                    <article>
                        <h1 class="entry-title"><a href="/a-blog-for-the-things-i-do.html">A Blog For The Things I Do</a></h1>
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/mcursa.html">mcursa</a>
        </li>
        <li class="published" title="2023-08-05T00:36:00+08:00">
          on&nbsp;Sat 05 August 2023
        </li>

	</ul>
<p>Categories: <a href="/tag/meta.html">meta</a> <a href="/tag/personal.html">personal</a> </p>
</div><!-- /.post-info --><!-- look into adding multiple categories: https://github.com/pelican-plugins/more-categories -->

<p>I&rsquo;ve started this blog to keep track of my personal projects and work (mis)adventures.
What I&rsquo;d like to accomplish by writing this blog (and hosting it on a static site):</p>
<ol>
<li>Securing snapshots of my memories across multiple facets of experience</li>
<li>Keeping a persistent journal somewhere for introspection/reflection </li>
<li>Playing around with some js (I work mainly on the backend at my job currently)</li>
</ol>
<p>I&rsquo;d like to host my own site one day with extra features:</p>
<ul>
<li>minigames</li>
<li>memory explorer (hopefully using a graph backend somehow)</li>
<li>comments</li>
</ul>
                    </article>
 
                </div>
            </aside><!-- /#featured -->
            
        
                <section id="extras" >
                    
                    
                </section><!-- /#extras -->
                
                <footer id="contentinfo" >
                    <address id="about" class="vcard ">
                        Proudly powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>, which takes
                        great advantage of <a href="http://python.org" target="_blank">Python</a>.
                        
                    </address><!-- /#about -->
                    
                    
                    
                </footer><!-- /#contentinfo -->
                
            </body>
            </html>
            