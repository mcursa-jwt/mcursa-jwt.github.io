<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Solving connection pooling and 2006</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="overriding dj_db_conn_pool’s ensure_connection() method with pre-ping and timer¶ We use dj_db_conn_pool as a simple way to pool connections in..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Chamber of Inspection</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/dev.html">Dev</a></li>
                    <li><a href="/category/personal.html">Personal</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/solving-connection-pooling-and-2006.html" rel="bookmark"
           title="Permalink to Solving connection pooling and 2006">Solving connection pooling and 2006</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-08-29T22:12:00+08:00">
                Published: Tue 29 August 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/mcursa.html">mcursa</a>
        </address>
<p>In <a href="/category/dev.html">Dev</a>.</p>
<p>tags: <a href="/tag/dev.html">dev</a> <a href="/tag/mysql.html">mysql</a> <a href="/tag/db.html">db</a> </p>
</footer><!-- /.post-info -->      <h1 id="overriding-dj_db_conn_pools-ensure_connection-method-with-pre-ping-and-timer">overriding <code>dj_db_conn_pool</code>&rsquo;s <code>ensure_connection()</code> method with pre-ping and timer<a class="headerlink" href="#overriding-dj_db_conn_pools-ensure_connection-method-with-pre-ping-and-timer" title="Permanent link">&para;</a></h1>
<p>We use <a href="https://pypi.org/project/django-db-connection-pool/">dj_db_conn_pool</a> as a simple way to pool connections in case of a surge in transactions initiated by client loads.</p>
<p>We were having trouble tweaking the library&rsquo;s parameters in <a href="#understanding-the-issue">the next section</a> to stop the <a href="https://dev.mysql.com/doc/refman/8.0/en/gone-away.html">mysql 2006 error</a> (<a href="https://stackoverflow.com/questions/26958592/django-after-upgrade-mysql-server-has-gone-away">stackoverflow</a>) from occurring on our process scheduling module&rsquo;s queries.</p>
<h3 id="the-fix-adding-a-ping-that-has-exception-handling-upon-failure">the fix: <a href="https://aber.sh/articles/Django-automatic-reconnect/">adding a ping (that has exception handling upon failure).</a><a class="headerlink" href="#the-fix-adding-a-ping-that-has-exception-handling-upon-failure" title="Permanent link">&para;</a></h3>
<p>This solves the problem for now - and still maintains pooling functionality.</p>
<!-- add logs to show still works -->

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">dj_db_conn_pool.backends.mysql</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">django.db.backends.utils</span> <span class="kn">import</span> <span class="n">CursorWrapper</span>
<span class="k">class</span> <span class="nc">DatabaseWrapper</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DatabaseWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    inherits dj_db_conn_pool.backends.mysql.base.DatabaseWrapper</span>

<span class="sd">    overrides ensure_connection to add pre-ping regardless</span>
<span class="sd">    of connection freshness (`sqlalchemy.pool.base._ConnectionFairy._checkout` function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">ensure_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wrapper references:</span>
<span class="sd">        ---</span>
<span class="sd">            - `type(self.connection)==sqlalchemy.pool.base._ConnectionFairy`</span>
<span class="sd">            - `type(self.connection.connection)==_mysql.connection`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ensuring existing connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="si">}</span><span class="s2"> with pre-ping.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">CursorWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_cursor</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to ensure existing connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="si">}</span><span class="s2">, creating new.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap_database_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</code></pre></div>

<p>I still don&rsquo;t really like that it sends an extra pre-ping for each.</p>
<p>I couldnt find a similar issue online, with <code>dj_db_conn_pool</code> and <code>apscheduler</code>. 
Didn&rsquo;t the <code>sqlalchemy</code>/<code>django</code>/<code>dj_db_conn_pool</code> libraries implement a pre-ping? Turns out they did.</p>
<h1 id="understanding-the-issue-wip">understanding the issue (WIP)<a class="headerlink" href="#understanding-the-issue-wip" title="Permanent link">&para;</a></h1>
<p>we use <a href="https://apscheduler.readthedocs.io/en/3.x/"><code>apscheduler</code></a> library to schedule our jobs. so far, the issue occurs mostly on scheduled job&rsquo;s db transactions.</p>
<p>initially, the 2006 errors almost only occurred on the queries I was using to flag the execution status of jobs. After I removed that, it occured on jobs (&ndash; my lead did mention that they might open a connection per thread)</p>
<p><strong>hypo:</strong>
the same connection might have been referenced for later use, but connection has either been disconnected from the mysql server or by the parameters set.</p>
<p>the important parameters (and their references):</p>
<p><code>Pool</code> (sqlalchemy/pool/base.py)</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Identified</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">EventTarget</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="o">...</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="c1"># self,</span>
        <span class="c1"># creator: Union[_CreatorFnType, _CreatorWRecFnType],</span>
        <span class="n">recycle</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1"># echo: log._EchoFlagType = None,</span>
        <span class="c1"># logging_name: Optional[str] = None,</span>
        <span class="c1"># reset_on_return: _ResetStyleArgType = True,</span>
        <span class="c1"># events: Optional[List[Tuple[_ListenerFnType, str]]] = None,</span>
        <span class="c1"># dialect: Optional[Union[_ConnDialect, Dialect]] = None,</span>
        <span class="n">pre_ping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="c1"># _dispatch: Optional[_DispatchCommon[Pool]] = None,</span>
    <span class="p">)</span>
        <span class="o">...</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param recycle: If set to a value other than -1, number of</span>
<span class="sd">              seconds between connection recycling, which means upon</span>
<span class="sd">              checkout, if this timeout is surpassed the connection will be</span>
<span class="sd">              closed and replaced with a newly opened connection. Defaults to -1.</span>
<span class="sd">        :param pre_ping: if True, the pool will emit a &quot;ping&quot; (typically</span>
<span class="sd">             &quot;SELECT 1&quot;, but is dialect-specific) on the connection</span>
<span class="sd">             upon checkout, to test if the connection is alive or not.   If not,</span>
<span class="sd">             the connection is transparently re-connected and upon success, all</span>
<span class="sd">             other pooled connections established prior to that timestamp are</span>
<span class="sd">             invalidated.     Requires that a dialect is passed as well to</span>
<span class="sd">             interpret the disconnection error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</code></pre></div>

<p><code>QueuePool</code> (sqlalchemy/pool/impl.py)</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QueuePool</span><span class="p">(</span><span class="n">Pool</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">creator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_CreatorFnType</span><span class="p">,</span> <span class="n">_CreatorWRecFnType</span><span class="p">],</span>
        <span class="n">pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_overflow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">use_lifo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param timeout: The number of seconds to wait before giving up</span>
<span class="sd">          on returning a connection. Defaults to 30.0. This can be a float</span>
<span class="sd">          but is subject to the limitations of Python time functions which</span>
<span class="sd">          may not be reliable in the tens of milliseconds.</span>
<span class="sd">          &quot;&quot;&quot;</span>
</code></pre></div>

<p>implementation: dj_db_conn_pool.core.mixins.PooledDatabaseWrapperMixin.get_new_connection()</p>
<p>Error was being thrown on connection fairy&rsquo;s _checkout method</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>